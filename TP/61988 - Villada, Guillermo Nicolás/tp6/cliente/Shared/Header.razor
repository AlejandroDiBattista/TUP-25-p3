@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject cliente.Services.ApiService ApiService
@inject NavigationManager Nav

<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
    <a class="navbar-brand" href="" @onclick="IrHome" style="cursor:pointer;">
        <img src="LogoNickzP.png" alt="Logo" style="height:100px;" /> Store Online
    </a>

    <div class="navbar-nav">
        <a class="nav-item nav-link" href="" @onclick="IrHome">Inicio</a>
        <a class="nav-item nav-link" href="/productos">Productos</a>
        <a class="nav-item nav-link" href="/carrito">Carrito</a>
        <a class="nav-item nav-link" href="/confirmar">Confirmar compra</a>
    </div>

    <form class="form-inline my-2 my-lg-0" @onsubmit="Buscar">
        <input class="form-control mr-sm-2" type="search" placeholder="Buscar" aria-label="Buscar" @bind="busqueda" />
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Buscar</button>
    </form>
    <div class="ml-auto">
        <button class="btn btn-outline-primary" @onclick="IrCarrito">
            <span class="oi oi-cart"></span>
            Carrito
            <span class="badge badge-pill badge-danger">@contador</span>
        </button>
    </div>
</nav>

@code {
    int contador = 0;
    string busqueda = "";

    protected override async Task OnInitializedAsync()
    {
        await ActualizarContador();
    }

    public async Task ActualizarContador()
    {
        var carritoId = await LocalStorage.GetItemAsync<Guid?>("carritoId");
        if (carritoId != null && carritoId != Guid.Empty)
        {
            var items = await ApiService.ObtenerCarritoAsync(carritoId.Value);
            contador = items.Sum(i => i.Cantidad);
        }
        else
        {
            contador = 0;
        }
        StateHasChanged();
    }

    private void IrCarrito()
    {
        Nav.NavigateTo("/carrito");
    }

    private void IrHome()
    {
        Nav.NavigateTo("/");
    }

    private void Buscar()
    {
        if (!string.IsNullOrWhiteSpace(busqueda))
            Nav.NavigateTo($"/productos?q={Uri.EscapeDataString(busqueda)}");
        else
            Nav.NavigateTo("/productos");
    }
}