@page "/confirmacion"
@using cliente.Services
@inject CarritoService CarritoService
@inject ApiService ApiService
@inject NavigationManager NavigationManager

<PageTitle>Confirmación de Compra</PageTitle>

<div class="container mt-4">
    <h2>Confirmación de compra</h2>
    <h4>Resumen del carrito</h4>
    <ul>
        @foreach (var item in CarritoService.Items)
        {
            <li>@item.Producto.Nombre x @item.Cantidad = $@(item.Producto.Precio * item.Cantidad)</li>
        }
    </ul>
    <h5>Total: $@CarritoService.CalcularTotal()</h5>

    <EditForm Model="cliente" OnValidSubmit="ConfirmarCompra">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="mb-3">
            <label>Nombre</label>
            <InputText class="form-control" @bind-Value="cliente.Nombre" />
        </div>
        <div class="mb-3">
            <label>Apellido</label>
            <InputText class="form-control" @bind-Value="cliente.Apellido" />
        </div>
        <div class="mb-3">
            <label>Email</label>
            <InputText class="form-control" @bind-Value="cliente.Email" />
        </div>
        <button class="btn btn-success" type="submit">Confirmar compra</button>
    </EditForm>
    @if (!string.IsNullOrEmpty(mensaje))
    {
        <div class="alert alert-info mt-3">@mensaje</div>
    }
</div>

@code {
    private ClienteDto cliente = new();
    private string mensaje;

    private async Task ConfirmarCompra()
    {
        // Aquí deberías llamar a tu ApiService para confirmar la compra
        // y limpiar el carrito si es exitoso
        var exito = await ApiService.ConfirmarCompraAsync(cliente);
        if (exito)
        {
            mensaje = "¡Compra confirmada! Gracias por tu compra.";
            CarritoService.VaciarCarrito();
            await Task.Delay(2000);
            NavigationManager.NavigateTo("/");
        }
        else
        {
            mensaje = "Error al confirmar la compra. Intenta nuevamente.";
        }
    }

    public class ClienteDto
    {
        public string Nombre { get; set; } = string.Empty;
        public string Apellido { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }
}
