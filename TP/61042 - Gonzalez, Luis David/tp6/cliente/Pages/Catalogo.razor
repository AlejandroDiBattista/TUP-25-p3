@page "/"
@using Microsoft.AspNetCore.Components.Web
@using cliente.Services
@inject cliente.Services.ApiService Api
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="header">
    <img src="logo.png" alt="Logo" class="logo" @onclick="@(() => Nav.NavigateTo("/"))" style="cursor:pointer;width:60px;" />
    <input placeholder="Buscar zapatilla..." @bind="busqueda" @bind:event="oninput" />
    <button @onclick="IrAlCarrito" class="carrito-btn">
        ðŸ›’ <span class="contador">@cantidadCarrito</span>
    </button>
</div>

<div class="productos">
    @if (productos == null)
    {
        <p>Cargando productos...</p>
    }
    else if (!productos.Any())
    {
        <p>No hay productos.</p>
    }
    else
    {
        @foreach (var p in productos)
        {
            <div class="producto">
                <img src="@p.ImagenUrl" alt="@p.Nombre" />
                <h3>@p.Nombre</h3>
                <p>@p.Descripcion</p>
                <p><b>Stock:</b> @p.Stock</p>
                <p><b>Precio:</b> $@p.Precio</p>
                <button @onclick="() => AgregarAlCarrito(p.Id)" disabled="@(p.Stock == 0)">Agregar al carrito</button>
            </div>
        }
    }
</div>

@code {
    string busqueda = "";
    List<Producto> productos;
    int cantidadCarrito = 0;
    Guid carritoId;

    protected override async Task OnInitializedAsync()
    {
        await CargarCarritoId();
        await Buscar();
        await ActualizarCantidadCarrito();
    }

    async Task Buscar()
    {
        productos = await Api.ObtenerProductosAsync(busqueda);
    }

    async Task AgregarAlCarrito(int productoId)
    {
        await Api.AgregarProductoAsync(carritoId, productoId, 1);
        await ActualizarCantidadCarrito();
    }

    async Task CargarCarritoId()
    {
        var idStr = await JS.InvokeAsync<string>("localStorage.getItem", "carritoId");
        if (!Guid.TryParse(idStr, out carritoId))
        {
            carritoId = await Api.CrearCarritoAsync();
            await JS.InvokeVoidAsync("localStorage.setItem", "carritoId", carritoId.ToString());
        }
    }

    async Task ActualizarCantidadCarrito()
    {
        var items = await Api.ObtenerCarritoAsync(carritoId);
        cantidadCarrito = items.Sum(i => i.Cantidad);
        StateHasChanged();
    }

    void IrAlCarrito() => Nav.NavigateTo("/carrito");
}
