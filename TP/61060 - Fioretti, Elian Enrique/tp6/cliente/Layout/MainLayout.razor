@using cliente.Services
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject ApiService ApiService

<div class="d-flex" style="align-items: flex-start;">
    <div 
         style="width:220px; min-width:220px; display:flex; flex-direction:column; align-items:center; padding-top:6px; height:220px; 
                background: url('@navBarLeftUrl') no-repeat center center; background-size: cover; background-color: transparent;">
        <img src="@bionicTechLogoUrl" alt="Bionic Tech" style="height:220px; width:220px; cursor:pointer; position:relative; z-index:1;" @onclick="IrHome" />
    </div>
    <div class="flex-grow-1">
        <div class="sticky-top mb-4" style="height:60px; display:flex; align-items:center; background-color: transparent; box-shadow: none;">
            <div class="container d-flex align-items-center justify-content-between"
                 style="height:60px; width:834px; margin-left:auto; background: url('@navBarRightUrl') no-repeat right center; background-size: cover;">
                <div class="d-flex align-items-center" style="padding-top:3px; margin-left:18px;">
                    <a class="btn btn-outline-secondary me-3" href="/carrito" style="min-width:100px; background-color:rgba(0, 255, 64, 0.25); color:rgb(218, 218, 218); border:1px solid rgb(218, 218, 218);">
                        Carrito
                    </a>
                </div>
                <div class="d-flex align-items-center justify-content-end" style="padding-top:3px; margin-right:17px;">
                    <form class="d-flex align-items-center" @onsubmit="Buscar">
                        <input class="form-control form-control-sm me-2 buscador-navbar" style="width:238px; background-color:rgba(0, 0, 0, 0.25); color:rgb(218, 218, 218); border:1px solid rgb(218, 218, 218);" type="search" placeholder="Buscar..." @bind="busqueda" />
                        <button class="btn btn-outline-primary ms-1" type="submit" style="min-width:100px; background-color:rgba(0, 255, 255, 0.25); color:rgb(218, 218, 218); border:1px solid rgb(218, 218, 218);">Buscar</button>
                    </form>
                </div>
            </div>
        </div>
        <main class="container">
            @Body
        </main>
    </div>
</div>

@code {
    private string bionicTechLogoUrl = "http://localhost:5184/img/hud/bionictechLogo.png";
    private string navBarLeftUrl = "http://localhost:5184/img/hud/navbarLeft.png";
    private string navBarRightUrl = "http://localhost:5184/img/hud/navbarRight.png";
    private string busqueda;
    private int contadorCarrito;

    protected override async Task OnInitializedAsync()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        await ActualizarContador();
    }

    private void OnLocationChanged(object sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await ActualizarContador();
    }

    private async Task ActualizarContador()
    {
        try
        {
            var items = await ApiService.ObtenerCarritoAsync();
            contadorCarrito = items?.Sum(i => i.Cantidad) ?? 0;
            StateHasChanged();
        }
        catch { contadorCarrito = 0; }
    }

    private void IrHome()
    {
        NavigationManager.NavigateTo("/");
    }

    private async Task Buscar()
    {
        if (!string.IsNullOrWhiteSpace(busqueda))
            NavigationManager.NavigateTo($"/?busqueda={Uri.EscapeDataString(busqueda)}");
        else
            NavigationManager.NavigateTo("/");
    }

    private bool EsCarrito
    {
        get
        {
            var uri = NavigationManager.ToBaseRelativePath(NavigationManager.Uri).TrimEnd('/');
            return uri.Equals("carrito", StringComparison.OrdinalIgnoreCase);
        }
    }
}
