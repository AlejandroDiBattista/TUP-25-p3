@page "/carrito"
@using Cliente.Models
@using Cliente.Services
@inject CarritoService CarritoService
@inject NavigationManager Navigation
@inject ApiService ApiService
@using System.ComponentModel.DataAnnotations

<PageTitle>Carrito de compras</PageTitle>

<header class="navbar navbar-expand-lg navbar-light bg-light sticky-top shadow p-3">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">üõçÔ∏è Tienda Gamer</a>
        <button class="btn btn-outline-primary" @onclick="IrAInicio">üè† Volver al cat√°logo</button>
    </div>
</header>

<div class="container mt-4">
    <h2>Carrito de compras</h2>

    <p><strong>Cantidad total de productos:</strong> @cantidadProductos</p>
    <button class="btn btn-outline-info" @onclick="ActualizarCantidad">üîÑ Actualizar cantidad</button>

    @if (cargando)
    {
        <div class="alert alert-info">Cargando carrito...</div>
    }
    else if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger">Error: @error</div>
    }
    else if (CarritoService.Items.Any())
    {
        <div class="row row-cols-1 row-cols-md-2 g-4">
            @foreach (var item in CarritoService.Items)
            {
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">@item.Nombre</h5>
                            <p><strong>Precio:</strong> $@item.PrecioUnitario</p>
                            <p><strong>Cantidad:</strong> @item.Cantidad</p>
                            <p><strong>Total:</strong> $@item.Importe</p>
                        </div>
                        <div class="card-footer text-end">
                            <button class="btn btn-danger" @onclick="() => EliminarDelCarrito(item.ProductoId)">Eliminar</button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="mt-4">
            <h4>Agregar producto</h4>
            <input type="number" @bind="productoId" placeholder="ID del producto" class="form-control mb-2" />
            <input type="number" @bind="productoCantidad" min="1" placeholder="Cantidad" class="form-control mb-2" />
            <button class="btn btn-outline-primary" @onclick="AgregarProductoAlCarrito">üõí Agregar al carrito</button>
        </div>

        <div class="mt-4">
            <h4>Detalles del Cliente</h4>
            <EditForm Model="@formulario" OnValidSubmit="EnviarFormulario">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label>Nombre:</label>
                    <InputText class="form-control" @bind-Value="formulario.Nombre" />
                </div>
                <div class="mb-3">
                    <label>Email:</label>
                    <InputText type="email" class="form-control" @bind-Value="formulario.Email" />
                </div>

                <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-danger" @onclick="VaciarCarrito">Vaciar carrito</button>
                    <button type="submit" class="btn btn-success">Confirmar compra</button>
                </div>
            </EditForm>
        </div>
    }
    else
    {
        <div class="alert alert-warning">No hay productos en tu carrito.</div>
    }
</div>

@code {
    private bool cargando = true;
    private string error = string.Empty;
    private int cantidadProductos;
    private int usuarioId = 1;
    private FormularioCompra formulario = new();
    private int productoId;
    private int productoCantidad = 1;
    private Guid carritoId = Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        await InicializarCarrito();
    }

    private async Task InicializarCarrito()
    {
        try
        {
            var carrito = await CarritoService.ObtenerCarritoAsync(usuarioId);
            if (carrito != null)
            {
                carritoId = carrito.Id;
                CarritoService.CargarItems(carrito.CarritoItems);
                await ActualizarCantidad();
            }
            else
            {
                error = "No se pudo cargar el carrito.";
            }
        }
        catch (Exception ex)
        {
            error = $"Error al cargar el carrito: {ex.Message}";
        }
        cargando = false;
        StateHasChanged();
    }

    private async Task EliminarDelCarrito(int productoId)
    {
        try
        {
            await CarritoService.EliminarProductoAsync(productoId);
            await InicializarCarrito();
        }
        catch (Exception ex)
        {
            error = $"Error al eliminar el producto: {ex.Message}";
        }
    }

    private async Task VaciarCarrito()
    {
        try
        {
            await CarritoService.VaciarCarritoAsync(usuarioId);
            await InicializarCarrito();
        }
        catch (Exception ex)
        {
            error = $"Error al vaciar el carrito: {ex.Message}";
        }
    }

    private async Task ActualizarCantidad()
    {
        try
        {
            cantidadProductos = await CarritoService.ObtenerCantidadProductos(carritoId);
        }
        catch (Exception ex)
        {
            error = $"Error al obtener cantidad de productos: {ex.Message}";
        }
    }

    private async Task AgregarProductoAlCarrito()
    {
        if (carritoId == Guid.Empty || productoId <= 0)
        {
            error = "Debe indicar un ID de producto v√°lido.";
            return;
        }

        var response = await CarritoService.AgregarProductoAsync(carritoId, productoId);
        if (response.IsSuccessStatusCode)
        {
            await InicializarCarrito();
        }
        else
        {
            error = "No se pudo agregar el producto al carrito.";
        }
    }

    private async Task EnviarFormulario()
    {
        try
        {
            await CarritoService.ConfirmarCompraAsync(usuarioId, formulario.Nombre, formulario.Email);
            Navigation.NavigateTo("/confirmacion");
        }
        catch (Exception ex)
        {
            error = $"Error al confirmar la compra: {ex.Message}";
        }
    }

    private void IrAInicio()
    {
        Navigation.NavigateTo("/");
    }
}
