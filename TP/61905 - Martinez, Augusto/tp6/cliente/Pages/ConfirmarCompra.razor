@page "/confirmar"
@using Cliente.Models
@using Cliente.Services
@using System.ComponentModel.DataAnnotations
@inject CarritoService CarritoService
@inject NavigationManager Navigation

<PageTitle>Confirmar Compra</PageTitle>

<h2>Confirmar Compra</h2>

@if (CarritoService.Items.Any())
{
    <div class="mb-4">
        <h4>Resumen del Carrito</h4>
        <ul>
            @foreach (var item in CarritoService.Items)
            {
                <li>@item.Cantidad Ã— @item.Nombre - $@(item.Cantidad * item.PrecioUnitario)</li>
            }
        </ul>
        <p><strong>Total:</strong> $@CarritoService.Total</p>
    </div>

    <EditForm Model="@formulario" OnValidSubmit="EnviarFormulario">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Nombre:</label>
            <InputText class="form-control" @bind-Value="formulario.Nombre" />
        </div>
        <div class="mb-3">
            <label>Email:</label>
            <InputText type="email" class="form-control" @bind-Value="formulario.Email" />
        </div>
        <div class="mb-3">
            <label>Confirmar Email:</label>
            <InputText type="email" class="form-control" @bind-Value="formulario.ConfirmarEmail" />
        </div>

        <button type="submit" class="btn btn-success">Confirmar Compra</button>
    </EditForm>
}
else
{
    <div class="alert alert-info">No hay productos en el carrito.</div>
}

@code {
     protected override async Task OnInitializedAsync()
    {
        await CarritoService.CargarDesdeApiAsync(1); // ðŸ‘ˆ recarga del backend
    }
    private FormularioCompra formulario = new();

    private async Task EnviarFormulario()
    {
        if (formulario.Email != formulario.ConfirmarEmail)
        {
            Console.WriteLine("Los emails no coinciden.");
            return;
        }

        try
        {
            await CarritoService.ConfirmarCompraAsync(1, formulario.Nombre, formulario.Email);
            Navigation.NavigateTo("/confirmacion");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al confirmar compra: {ex.Message}");
        }
    }

    public class FormularioCompra
    {
        [Required(ErrorMessage = "El nombre es obligatorio")]
        public string Nombre { get; set; }

        [Required(ErrorMessage = "El email es obligatorio")]
        [EmailAddress(ErrorMessage = "El email no es vÃ¡lido")]
        public string Email { get; set; }

        [Required(ErrorMessage = "Confirma tu email")]
        [EmailAddress(ErrorMessage = "El email no es vÃ¡lido")]
        public string ConfirmarEmail { get; set; }
    }
}
